
## 동시성 이슈 분석 보고서
- - -

### #1. **포인트 충전 동시 요청**
- **문제 설명**: 동일 사용자가 포인트를 동시에 여러 번 충전 요청 시, 요청 간 레이스 컨디션으로 인해 **최종 잔액이 올바르지 않게 기록될 수 있음**.
- **원인**: 트랜잭션 간 충돌 없이 update가 진행되면 마지막 update만 반영되어 중간 값이 덮어씀.
- **해결 방향**: 충돌 가능성은 낮지만, 무결성이 중요한 데이터이므로 **선택적 락(@Version 사용)** 으로 버전 체크를 통한 정합성 보장.

---

### #2. **포인트 충전 / 결제 동시 요청**
- **문제 설명**: 포인트를 충전하는 중 동시에 결제를 진행할 경우, 충전된 포인트가 실제 결제에 반영되지 않거나 **결제 실패 또는 과소 결제 발생** 가능.
- **원인**: 충전과 차감 로직이 트랜잭션 분리되어 있어, 중간 상태의 포인트가 다른 트랜잭션에 영향을 줌.
- **해결 방향**: 트랜잭션 충돌 빈도는 낮으므로 선택적 락도 고려.

---

### #3. **결제 동시 요청 - 포인트 충복 차감**
- **문제 설명**: 동일 사용자가 동시에 결제를 요청하는 경우, 중복 결제 발생할 수 있음.
- **원인**: 동치 요청 시 Uncommitted Change 문제가 발생하여, 결제 상태가 서로 다른 트랜잭션에서 포인트 차감이 중복으로 이루어짐.
- **해결 방향**: 충돌 가능성이 낮지만, 무결성이 중요한 데이터이므로 **선택적 락(@Version 사용)** 으로 버전 체크를 통한 정합성 보장. 예외 발생 시 에러 처리.

---

### #4. **쿠폰 사용 동시 요청**
- **문제 설명**: 동일 쿠폰을 여러 요청이 동시에 사용하면, 한 쿠폰이 중복 적용될 수 있음.
- **원인**: 쿠폰 사용 여부(`isUsed`) 체크 → 사용 상태 변경 사이에 다른 트랜잭션이 접근 가능.
- **해결 방향**: 충돌 가능성이 낮기 때문에 **선택적 락 + 예외 처리** 조합으로 해결. 예: 쿠폰에 `@Version`을 걸고 버전 충돌 시 재시도 로직 구현.

---

### #5. **쿠폰 발급 동시 요청**
- **문제 설명**: 쿠폰 수량이 한정돼 있을 때, 다수 사용자가 동시에 발급을 요청하면 **재고 초과 발급** 가능.
- **원인**: 발급 시 재고 차감이 동기화되지 않아서, 조건은 통과했지만 DB 반영 전에 다른 트랜잭션이 먼저 차감해버릴 수 있음.
- **해결 방향**: 선착순 쿠폰으로 잦은 충돌 예상되므로 **비관적 락 (select for update)** 을 통해 재고 수량을 직접 잠그고 동시 접근 차단.

---

### #6. **주문 동시 요청**
- **문제 설명**: 여러 사용자가 동시에 같은 상품을 주문하면, **실제보다 많은 재고가 판매되는 오버셀링** 발생 가능.
- **원인**: 재고 수량 차감 전 확인 → 차감 로직 사이에 다른 트랜잭션이 재고를 먼저 사용.
- **해결 방향**: 인기상품에 대한 잦은 충돌 예상되므로, **비관적 락** 적용하여 직렬 처리.

---

### #7. **주문 취소 동시 요청**
- **문제 설명**: 주문 취소 시 상품 재고를 되돌리는데, 중복 요청 시 **재고가 잘못 증가**할 수 있음.
- **원인**: 재고 수량 증가 로직이 트랜잭션 경합 없이 중복 수행됨.
- **해결 방향**: **비관적 락** 적용하여 재고 증가 처리 중 다른 요청 차단 필요.

---

### #8. **주문/주문 취소 동시 요청**
- **문제 설명**: 동시에 주문과 취소 요청이 발생하면, 재고 감소와 증가가 충돌하여 **최종 재고 상태가 불일치**할 수 있음.
- **원인**: 두 작업이 서로 다른 방향(감소/증가)으로 재고를 동시에 수정.
- **해결 방향**: 재고 변경은 항상 충돌 가능성이 있으므로 **비관적 락으로 직렬화 처리**.

---

### ✅ **동시성 이슈 분석표**

| 이슈번호 | 이슈명                 | 문제 설명 | 원인 | 충돌 빈도 | 해결 방안 |
|------|---------------------|------------|--------|-------------|--------------|
| #1   | 포인트 충전 동시 요청        | 여러 포인트 충전 요청 간 레이스 컨디션으로 잔액 불일치 발생 | 마지막 요청만 반영되며 중간 결과가 덮어써짐 | 낮음 | 낙관적 락 |
| #2   | 포인트 충전 / 결제 동시 요청   | 충전 중 결제로 인해 포인트 정합성 깨질 수 있음 | 충전/결제가 별도 트랜잭션에서 처리됨 | 낮음 | 낙관적 락 |
| #3   | 결제 동시 요청 (포인트 중복 차감) | 중복 결제로 포인트 과차감 발생 가능 | 결제 상태가 확정되기 전에 중복 처리됨 | 낮음 | 낙관적 락 |
| #4   | 쿠폰 사용 동시 요청         | 동일 쿠폰이 여러 번 사용될 수 있음 | 사용 상태 변경 전 다른 트랜잭션이 접근 | 낮음 | 낙관적 락 |
| #5   | 쿠폰 발급 동시 요청         | 재고 초과 발급 가능 | 조건 통과 후 재고 차감 전 다른 트랜잭션 접근 | 높음 | 비관적 락 |
| #6   | 주문 동시 요청            | 재고보다 많은 주문 처리 (오버셀링) 발생 | 재고 확인과 차감 사이 다른 요청이 선점 | 높음 | 비관적 락 |
| #7   | 주문 취소 동시 요청         | 중복 취소로 재고 과다 증가 가능 | 동일 주문에 대해 중복 복원 로직 수행됨 | 중간 | 비관적 락 |
| #8   | 주문/ 주문 취소 동시 요청     | 재고 증가·감소 충돌로 최종 상태 불일치 | 상반된 재고 변경이 동시에 발생 | 중간 | 비관적 락 |

---

### AS-IS, TO-BE

- #1, #2, #3
  - AS-IS : 포인트 동시 변경 시 정합성 문제 발생 + 포인트 사용 이력 FK로 인해 DeadLock 발생
    - #1 : 1000 충전 요청 4회 - expected: <4000> but was: <2000>
    - #2 : 1000 충전/결제 요청 각각 2회 - expected: <10000> but was: <8000>
    - #3 : 1000 결제 요청 4회 - expected: <6000> but was: <9000>
    - 모든 케이스에서 데이터 정합성 문제 발생
  - TO-BE : @Version을 통한 충돌 감지, 충돌 빈도는 거의 없다고 판단하였으며, 동시에 요청된 건이면 따닥 오류로 판단하여 실패 처리, 재시도 제외 + FK 제거하여 DeadLock 방지
    - #1 : 충전 요청 시 @Version 체크 후 충돌 발생 시 에러 처리 - 4회 요청 중 2회 성공, 2회 실패
    - #2 : 충전/결제 요청 시 @Version 체크 후 충돌 발생 시 에러 처리 - 4회 요청 중 2회 성공, 2회 실패
    - #3 : 결제 요청 시 @Version 체크 후 충돌 발생 시 에러 처리 - 4회 요청 중 2회 성공, 2회 실패
    - 모든 케이스에서 데이터 정합성 문제 해결
- #4
  - AS-IS : 쿠폰 사용 시 중복 사용 가능 + 사용 이력 FK로 인해 DeadLock 발생
    - 데이터 정합성 문제 발생
  - TO-BE : @Version을 통한 충돌 감지, 충돌 빈도는 거의 없다고 판단하였으며, 동시에 요청 건은 오류로 판단하여 실패로 처리, 재시도 제외 + FK 제거하여 DeadLock 방지
    - 쿠폰 사용 요청 시 @Version 체크 후 충돌 발생 시 에러 처리 - 4회 요청 중 1건만 성공, 나머지 실패
    - 데이터 정합성 문제 해결
- #5
  - AS-IS : 쿠폰 발급 시 재고 초과 발급 가능
    - 총 재고 100개, 발급 요청 4회 - expected: <96> but was: <98> 
    - 쿠폰 재고 데이터 정합성 문제 발생
  - TO-BE : 선착순 발급은 동시 요청이 많은 서비스로 판단하여 비관적 락 적용 - 비관적 락 적용 메서드(findCouponByIdForUpdate) 생성하여 쿠폰 발급시 해당 메서드로 조회 
    - 쿠폰 발급 요청 시 비관적 락을 통해 재고 차감 후 발급 처리
    - 데이터 정합성 문제 해결
- #6, #8
  - AS-IS : 동시 주문, 동시 주문/주문 취소 시 상품 재고 정합성 문제 발생
    - 주문 요청 4회 - expected: <60> but was: <80>
    - 주문, 주문취소 요청 각각 2회 - expected: <100> but was: <80>
    - 주문/주문 취소 요청 시 재고 데이터 정합성 문제 발생
  - TO-BE : 인기 상품에 대해 동시 요청이 많이 발생할 것으로 판단하여 비관적 락 적용 - 비관적 락 적용 메서드(findProductByIdForUpdate) 생성하여 주문 시 해당 메서드로 조회
    - 주문 요청 시 비관적 락을 통해 조회 후 재고 차감
    - 주문 취소 요청 시 비관적 락을 통해 조회 후 재고 증가
    - 데이터 정합성 문제 해결
- #7
  - AS-IS : 주문 취소 시 증복 취소 가능성
    - 상품재고 - expected: <110> but was: <110> - 재고는 읽어온 시점이 테스트 케이스에서는 같기 때문에 일치
    - 주문 취소 요청 4회 - expected: <1> but was: <3> - 주문취소 성공횟수 3회
    - 주문 취소 요청 시 재고 데이터 정합성 문제 발생 - 주문 취소 요청 시 재고 증가 로직이 트랜잭션 경합 없이 중복 수행됨
  - TO-BE : 주문 취소 요청은 한 번만 가능하며, 상품 쪽에서 재고로 오류 판단이 불가능하며, 같은 주문에 대한 중복 취소 요청은 오류로 봐도 무방하므로 주문에 대해 낙관적 락 적용 및 재시도 제외
    - 상품 재고 110개 일치
    - 주문 취소 요청 시 @Version 체크 후 충돌 발생 시 에러 처리 - 4회 요청 중 1회 성공, 3회 실패
    - 데이터 정합성 문제 해결

---

### ✅ 동시성 이슈 개선 요약표

| 구분 | 시나리오 | AS-IS 문제 | TO-BE 개선 방향                  | 처리 결과 |
|------|----------|------------|------------------------------|------------|
| #1 | 포인트 충전 4회 | 중간 값 덮어씀 (정합성 오류)<br>Deadlock 발생 | `@Version` 통한 충돌 감지<br>FK 제거 | 2회 성공, 2회 실패 |
| #2 | 충전 2회 + 결제 2회 | 정합성 오류<br>Deadlock 발생 | `@Version` 충돌 감지<br>FK 제거    | 2회 성공, 2회 실패 |
| #3 | 결제 4회 | 과소 차감 (정합성 오류)<br>Deadlock 발생 | `@Version` 충돌 감지<br>FK 제거    | 2회 성공, 2회 실패 |
| #4 | 쿠폰 사용 4회 | 중복 사용 <br>Deadlock 발생 | `@Version` 충돌 감지<br>FK 제거    | 1회 성공, 3회 실패 |
| #5 | 쿠폰 발급 4회 (재고 100) | 재고 초과 발급 | 비관적 락 적용 (`FOR UPDATE`)      | 재고 차감 정확 (정합성 유지) |
| #6 | 주문 4회 (재고 100) | 오버셀링 발생 (정합성 오류) | 비관적 락 적용 (`FOR UPDATE`)      | 2회 성공, 재고 정확 |
| #7 | 주문+취소 2회씩 | 재고 충돌로 불일치 | 비관적 락 적용 (`FOR UPDATE`) | 재고 정확히 반영 |
| #8 | 주문 취소 4회 | 중복 취소로 재고 과증가 | `@Version` 적용<br>중복 취소 차단    | 1회 성공, 3회 실패 |

---